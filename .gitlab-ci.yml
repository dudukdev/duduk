variables:
  INSTANCE: 'Writerside/in'
  ARTIFACT: 'webHelpIN2-all.zip'
  DOCKER_VERSION: '241.15989'

stages:
  - test
  - build
  - deploy

unit tests:
  stage: test
  image: node:20-alpine
  before_script:
    - npm ci
  script:
    - npm run test
  coverage: '/Statements[^\d]*([\d\.]+)/'
  artifacts:
    when: always
    paths:
      - reports
      - coverage
    reports:
      junit: reports/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

writerside build:
  stage: build
  image: registry.jetbrains.team/p/writerside/builder/writerside-builder:$DOCKER_VERSION
  only:
    changes:
      - packages/documentation/**/*
  script:
    - set -e
    - export DISPLAY=:99
    - Xvfb :99 &
    - /opt/builder/bin/idea.sh helpbuilderinspect -source-dir ./packages/documentation -product $INSTANCE --runner gitlab -output-dir public/ || true
    - echo "Testing existence of $ARTIFACT..."
    - test -e public/$ARTIFACT
  artifacts:
    paths:
      - public/$ARTIFACT
      - public/report.json
    expire_in: 1 week

writerside check:
  stage: build
  image: openjdk:18-jdk-alpine
  only:
    changes:
      - packages/documentation/**/*
  needs:
    - writerside build
  before_script:
    - apk add curl
  script:
    - cd public
    - curl -o wrs-checker.jar -L https://packages.jetbrains.team/maven/p/writerside/maven/com/jetbrains/writerside/writerside-ci-checker/1.0/writerside-ci-checker-1.0.jar
    - java -jar wrs-checker.jar report.json $INSTANCE

pages:
  stage: deploy
  image: ubuntu:latest
  only:
    changes:
      - packages/documentation/**/*
    refs:
      - main
  before_script:
    - apt-get update -y && apt-get install unzip -y
  script:
    - cd \public
    - unzip -O UTF-8 $ARTIFACT
  artifacts:
    paths:
      - public
    expire_in: 1 week
